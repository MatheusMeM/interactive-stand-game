# app/ui/screens.kv
#:kivy 2.1.0

# Define brand colors for reusability
#:set color_primary_blue (0/255, 64/255, 119/255, 1)      # #004077
#:set color_secondary_blue (0/255, 105/255, 180/255, 1)      # #004077
#:set color_primary_green (134/255, 188/255, 37/255, 1)   # #86BC25
#:set color_secondary_green (82/255, 174/255, 50/255, 1)   # #86BC25
#:set color_white (1, 1, 1, 1)
#:set color_dark_gray (137/255, 137/255, 137/255, 1) # rgba(137, 137, 137, 1)
#:set color_light_gray (216/255, 206/255, 205/255, 1) # rgba(216, 206, 205, 1)
#:set screen_padding dp(120)

# Base styles for widgets to maintain consistency
<BrandedButton@Button>:
    font_name: 'Roboto'
    background_color: 0,0,0,0 # Make the default background transparent
    color: color_primary_blue
    font_size: '70sp'
    bold: True
    background_normal: ''

    canvas.before:
        Color:
            # Use the button's state to change color on press
            rgba: color_primary_green if self.state == 'normal' else color_secondary_green
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(30)] # The radius for the rounded corners. dp(20) is a good starting point.

# Quiz-specific button that allows color control from Python
<QuizButton>:
    font_name: 'Roboto'
    background_color: 0,0,0,0 # Make the default background transparent
    color: color_primary_blue
    font_size: '70sp'
    bold: True
    background_normal: ''

    canvas.before:
        Color:
            rgba: self.button_bg_color
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(30)]


<BrandedLabel@Label>:
    font_name: 'Roboto'
    color: color_primary_blue
    halign: 'center'
    valign: 'middle'

# --- Screen Designs ---

<WelcomeScreen>:
    name: 'welcome'
    canvas.before:
        Color:
            rgba: color_white
        Rectangle:
            pos: self.pos
            size: self.size
    FloatLayout:
        Image:
            source: 'assets/images/background_graphic.png'
            allow_stretch: True
            keep_ratio: False
            opacity: 0.15
        Image:
            source: 'assets/images/ibp_logo.png'
            size_hint: 0.55, 0.55
            pos_hint: {'center_x': 0.5, 'center_y': 0.6}
        BrandedButton:
            text: 'Toque para come√ßar'
            size_hint: 0.8, 0.15
            pos_hint: {'center_x': 0.5, 'center_y': 0.15}
            on_press: app.game_manager.show_instructions()

<InstructionsScreen>:
    name: 'instructions'
    canvas.before:
        Color:
            rgba: color_white
        Rectangle:
            pos: self.pos
            size: self.size
    Image:
        source: 'assets/images/background_graphic.png'
        allow_stretch: True
        keep_ratio: False
        opacity: 0.15

    # Main layout that respects the global screen padding
    BoxLayout:
        orientation: 'vertical'
        padding: screen_padding
        spacing: dp(25)


        BoxLayout:
            size_hint_y: 0.2
            orientation: 'vertical'
            spacing: dp(60)


        # --- TOP 5/8: The Dialog Box ---
        BoxLayout:
            size_hint_y: 0.4 # This is 5/8
            padding: dp(60)
            canvas.before:
                Color:
                    rgba: color_light_gray
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(30)]
            BoxLayout:
                orientation: 'vertical'
                spacing: dp(15)
                
                BrandedLabel:
                    id: title_label
                    text: 'Placeholder Title'
                    font_size: '60sp'
                    bold: True
                    size_hint_y: None
                    height: self.texture_size[1] # Make height fit the text
                    halign: 'center'

                BrandedLabel:
                    id: body_label
                    text: 'Placeholder Body Text'
                    markup: True
                    font_size: '40sp'
                    text_size: self.width, None
                    valign: 'top'
                    halign: 'left'
                    padding: [dp(50)]

        # --- BOTTOM 3/8: The Start Button and Logo ---
        BoxLayout:
            size_hint_y: 0.2 # This is 3/8
            orientation: 'vertical'
            spacing: dp(60)
            
            BrandedButton:
                id: action_button # <-- NEW ID
                text: 'PLACEHOLDER'
                size_hint: 1, 0.7
                on_press: app.game_manager.proceed_from_instructions()
       
        BoxLayout:
            size_hint_y: 0.1
            orientation: 'vertical'
            spacing: dp(0)

        BoxLayout:
            size_hint_y: 0.1
            orientation: 'vertical'
            spacing: dp(0)
           
            Image:
                source: 'assets/images/ibp_logo_simples.png'
                size_hint: 1, 0.2
                allow_stretch: True
                keep_ratio: True

<AgilityGameScreen>:
    name: 'agility_game'
    canvas.before:
        Color:
            rgba: color_white
        Rectangle:
            pos: self.pos
            size: self.size
    Image:
        source: 'assets/images/background_graphic.png'
        allow_stretch: True
        keep_ratio: False
        opacity: 0.15

    # --- CORRECTED LAYOUT: Reverting to FloatLayout for centering ---

    FloatLayout:
        # The dialog box, now acting as the chronometer's frame
        BoxLayout:
            id: game_layout
            orientation: 'vertical'
            size_hint: 0.56, 0.36 # A bit taller to feel more balanced
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            padding: (dp(20), dp(40)) # More vertical padding
            spacing: dp(1)
            opacity: 0
            canvas.before:
                Color:
                    rgba: color_light_gray
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(30)]

            # --- NEW SIMPLIFIED HIERARCHY ---
            BrandedLabel:
                text: 'TEMPO'
                font_size: '40sp'
                size_hint_y: 0.3
                valign: 'bottom' # Aligns to the bottom of its space
            
            BrandedLabel:
                id: chronometer_label
                text: '00:00'
                font_size: '180sp' # Extra large font
                bold: True
                size_hint_y: 0.4 

            BrandedLabel:
                id: remaining_label
                text: 'Restantes: 10'
                font_size: '50sp'
                size_hint_y: 0.3
                valign: 'top' # Aligns to the top of its space
        # Countdown Overlay (It's a sibling in the FloatLayout, so it covers everything)
        BrandedLabel:
            id: countdown_overlay
            text: ''
            font_size: '240sp'
            bold: True
            color: color_primary_blue
            canvas.before:
                Color:
                    rgba: color_white
                Rectangle:
                    pos: self.pos
                    size: self.size

<QuizGameScreen>:
    name: 'quiz_game'
    canvas.before:
        Color:
            rgba: color_white
        Rectangle:
            pos: self.pos
            size: self.size
    Image:
        source: 'assets/images/background_graphic.png'
        allow_stretch: True
        keep_ratio: False
        opacity: 0.15
    
    # Master layout to enforce padding and vertical structure
    BoxLayout:
        orientation: 'vertical'
        padding: screen_padding
        spacing: dp(25)

        # --- Question Dialog Box (40% of vertical space) ---
        BoxLayout:
            size_hint_y: 0.4
            padding: dp(30)
            canvas.before:
                Color:
                    rgba: color_light_gray
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(30)]
            BrandedLabel:
                id: question_label
                text: 'A carregar pergunta...'
                font_size: '32sp'
                # Allow text to wrap within the available width
                text_size: self.width, None

        # --- 2x2 Answer Grid (60% of vertical space) ---
        GridLayout:
            id: answers_grid
            cols: 2
            spacing: dp(15)
            size_hint_y: 0.6
            
            # Note: on_press now passes the button widget itself (self).
            # This is more powerful as it gives the logic full context.
            QuizButton:
                id: option_a
                on_press: app.game_manager.check_answer_by_id('option_a')
            QuizButton:
                id: option_b
                on_press: app.game_manager.check_answer_by_id('option_b')
            QuizButton:
                id: option_c
                on_press: app.game_manager.check_answer_by_id('option_c')
            QuizButton:
                id: option_d
                on_press: app.game_manager.check_answer_by_id('option_d')

<ScoreScreen>:
    name: 'score'
    canvas.before:
        Color:
            rgba: color_white
        Rectangle:
            pos: self.pos
            size: self.size
    Image:
        source: 'assets/images/background_graphic.png'
        allow_stretch: True
        keep_ratio: False
        opacity: 0.15
    BoxLayout:
        orientation: 'vertical'
        padding: 50
        spacing: 20
        BrandedLabel:
            text: 'Congratulations!'
            font_size: '50sp'
        BrandedLabel:
            id: final_score_label
            text: 'Your Final Score: 0'
            font_size: '40sp'
        TextInput:
            id: name_input
            hint_text: 'ENTER YOUR INITIALS'
            font_name: 'Roboto'
            font_size: '35sp'
            multiline: False
            readonly: True
            halign: 'center'
            size_hint_y: None
            height: '60dp'
        BrandedButton:
            text: 'Submit Score'
            on_press: app.game_manager.submit_score(name_input.text)
        VKeyboard:
            target: name_input
            layout: 'qwerty'

<LeaderboardScreen>:
    name: 'leaderboard'
    canvas.before:
        Color:
            rgba: color_white
        Rectangle:
            pos: self.pos
            size: self.size
    Image:
        source: 'assets/images/background_graphic.png'
        allow_stretch: True
        keep_ratio: False
        opacity: 0.15
    BoxLayout:
        orientation: 'vertical'
        padding: 20
        spacing: 10
        BrandedLabel:
            text: 'Hall of Fame'
            font_size: '50sp'
            size_hint_y: 0.2
        BrandedLabel:
            id: congrats_label
            text: ''
            font_size: '30sp'
            size_hint_y: 0.1
            color: color_primary_green
        GridLayout:
            id: leaderboard_grid
            cols: 3
            size_hint_y: 0.6
        BrandedButton:
            text: 'Play Again'
            size_hint_y: 0.1
            on_press: app.game_manager.return_to_welcome()